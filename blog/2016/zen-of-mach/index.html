<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="The Zen of Mach" />
<meta property="og:description" content="Mach is the Mozilla developer&rsquo;s swiss army knife. It gathers all the important commands you&rsquo;ll ever
need to run, and puts them in one convenient place. Instead of hunting down documentation, or asking
for help on irc, often a simple |mach help| is all that&rsquo;s needed to get you started. Mach is great.
But lately, mach is becoming more like the Mozilla developer&rsquo;s toolbox. It still has everything you
need but it weighs a ton, and it takes a good deal of rummaging around to find anything.

Frankly, a good deal of the mach commands that exist now are either poorly written, confusing to use,
or even have no business being mach commands in the first place. Why is this important? What&rsquo;s wrong
with having a toolbox?

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ahal.ca/blog/2016/zen-of-mach/" />



<meta property="article:published_time" content="2016-02-12T00:00:00&#43;00:00"/>

<meta property="article:modified_time" content="2016-02-12T00:00:00&#43;00:00"/>











<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="The Zen of Mach"/>
<meta name="twitter:description" content="Mach is the Mozilla developer&rsquo;s swiss army knife. It gathers all the important commands you&rsquo;ll ever
need to run, and puts them in one convenient place. Instead of hunting down documentation, or asking
for help on irc, often a simple |mach help| is all that&rsquo;s needed to get you started. Mach is great.
But lately, mach is becoming more like the Mozilla developer&rsquo;s toolbox. It still has everything you
need but it weighs a ton, and it takes a good deal of rummaging around to find anything.

Frankly, a good deal of the mach commands that exist now are either poorly written, confusing to use,
or even have no business being mach commands in the first place. Why is this important? What&rsquo;s wrong
with having a toolbox?

"/>
<meta name="generator" content="Hugo 0.42.1" />


    
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "headline": "The Zen of Mach",
  "url": "https://ahal.ca/blog/2016/zen-of-mach/",
  "wordCount": "1291",
  "datePublished": "2016-02-12T00:00:00&#43;00:00",
  "dateModified": "2016-02-12T00:00:00&#43;00:00",
  "author": {
    "@type": "Person",
    "name": "Andrew Halberstadt"
  },
  "keywords": "ateam, mach, mozilla"
}
</script>



    <link rel="canonical" href="https://ahal.ca/blog/2016/zen-of-mach/">

    <title>The Zen of Mach | Hunting the Shmoo</title>

    <!-- combined, minified CSS -->
    <link href="https://ahal.ca/css/style.css" rel="stylesheet" integrity="sha384-TbfEhJn4HkgPUIZUhhHaAYsycYKHxSuIloCjZOiyCSpbVunRQxg5T5pxKVFwxilF" crossorigin="anonymous">

    

    

    

    <link rel="shortcut icon" href="/favicon.png">
<link href="https://ahal.ca/css/bootstrap.min.css" rel="stylesheet">
<link href="https://ahal.ca/css/override.css" rel="stylesheet">
<link href="https://ahal.ca/css/debugprint.css" rel="stylesheet">
<script type="text/javascript" src="/js/menu.js"></script>

  </head>

  <body>

    
    <div class="blog-masthead">
      <div class="container">
        <nav class="nav blog-nav">
          <a class="nav-link " href="https://ahal.ca/">Home</a>
          
          <a class="nav-link active" href="/blog/" title="">Blog</a>
          
          
          <a class="nav-link" href="/casts/" title="">Casts</a>
          
        </nav>
      </div>
    </div>
    

    
    <header class="blog-header">
      <div class="container">
        <h1 class="blog-title"><a href="https://ahal.ca/" rel="home">Hunting the Shmoo</a></h1>
        <p class="lead blog-description">Screencasts and blog posts on workflow, productivity, tools, Mozilla and whatever else tickles my fancy.</p>
      </div>
    </header>
    

    
    <div class="container">
      <div class="row">
        <div class="col-sm-8 blog-main">

          


<article class="blog-post">
  <header>
    <h2 class="blog-post-title"><a href="https://ahal.ca/blog/2016/zen-of-mach/">The Zen of Mach</a></h2>
    <p class="blog-post-meta"><time datetime="2016-02-12T00:00:00Z">Feb 12, 2016</time> by Andrew Halberstadt in 

<i class="fa fa-tag" aria-hidden="true"></i>&nbsp;<a href="/tags/ateam" rel="tag">ateam</a>, <a href="/tags/mach" rel="tag">mach</a>, <a href="/tags/mozilla" rel="tag">mozilla</a>

</p>
  </header>
  <p>Mach is the Mozilla developer&rsquo;s swiss army knife. It gathers all the important commands you&rsquo;ll ever
need to run, and puts them in one convenient place. Instead of hunting down documentation, or asking
for help on irc, often a simple |mach help| is all that&rsquo;s needed to get you started. Mach is great.
But lately, mach is becoming more like the Mozilla developer&rsquo;s toolbox. It still has everything you
need but it weighs a ton, and it takes a good deal of rummaging around to find anything.</p>

<p>Frankly, a good deal of the mach commands that exist now are either poorly written, confusing to use,
or even have no business being mach commands in the first place. Why is this important? What&rsquo;s wrong
with having a toolbox?</p>

<p></p>

<p>Here&rsquo;s a quote from an <a href="http://www.gigamonkeys.com/flowers/">excellent article</a> on engineering effectiveness from the Developer
Productivity lead at Twitter:</p>

<blockquote>
<p>Finally there’s a psychological aspect to providing good tools to engineers that I have to
believe has a really (sic) impact on people’s overall effectiveness. On one hand, good tools are
just a pleasure to work with. On that basis alone, we should provide good tools for the same
reason so many companies provide awesome food to their employees: it just makes coming to work
every day that much more of a pleasure. But good tools play another important role: because the
tools we use are themselves software, and we all spend all day writing software, having to do so
with bad tools has this corrosive psychological effect of suggesting that maybe we don’t
actually know how to write good software. Intellectually we may know that there are different
groups working on internal tools than the main features of the product but if the tools you use
get in your way or are obviously poorly engineered, it’s hard not to doubt your company’s
overall competence.</p>
</blockquote>

<p>Working with good tools is a pleasure. Rather than breaking mental focus, they keep you in the zone.
They do not deny you your zen. Mach is the frontline, it is the main interface to Mozilla for most
developers. For this reason, it&rsquo;s especially important that mach and all of its commands are an
absolute joy to use.</p>

<p>There is already <a href="http://gecko.readthedocs.org/en/latest/python/mach/commands.html">good</a> <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/mach#Adding_Features_to_mach">documentation</a> for building a mach command, so I&rsquo;m not going to go
over that. Instead, here are some practical tips to help keep your mach command simple, intuitive
and enjoyable to use.</p>

<h2 id="keep-logic-out-of-it">Keep Logic out of It</h2>

<p>As awesome as mach is, it doesn&rsquo;t sprinkle magic fairy dust on your messy jumble of code to make it
smell like a bunch of roses. So unless your mach command is trivial, don&rsquo;t stuff all your logic into
a single <code>mach_commands.py</code>. Instead, create a dedicated python package that contains all your functionality,
and turn your <code>mach_commands.py</code> into a dumb dispatcher. This python package will henceforth be
called the &lsquo;underlying library&rsquo;.</p>

<p>Doing this makes your command more maintainable, more extensible and more re-useable. It&rsquo;s a
no-brainer!</p>

<h2 id="no-global-imports">No Global Imports</h2>

<p>Other than things that live in the stdlib, mozbuild or mach itself, don&rsquo;t import anything in a
<code>mach_commands.py</code>&rsquo;s global scope. Doing this will evaluate the imported file any time the <code>mach</code>
binary is invoked. No one wants your module to load itself when running an unrelated command or
|mach help|.</p>

<p>It&rsquo;s easy to see how this can quickly add up to be a huge performance cost.</p>

<h2 id="re-use-the-argument-parser">Re-use the Argument Parser</h2>

<p>If your underlying library has a CLI itself, don&rsquo;t redefine all the arguments with
<code>@CommandArgument</code> decorators. Your redefined arguments will get out of date, and your users will
become frustrated. It also encourages a pattern of adding &lsquo;mach-only&rsquo; features, which seem like a
good idea at first, but as I explain in the next section, leads down a bad path.</p>

<p>Instead, import the underlying library&rsquo;s <code>ArgumentParser</code> directly. You can do this by using the
<code>parser</code> argument to the <code>@Command</code> decorator. It&rsquo;ll even conveniently accept a callable so you
can avoid global imports. Here&rsquo;s an example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setup_argument_parser</span>():
    <span style="color:#f92672">from</span> mymodule <span style="color:#f92672">import</span> MyModuleParser
    <span style="color:#66d9ef">return</span> MyModuleParser()

<span style="color:#a6e22e">@CommandProvider</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MachCommands</span>(object):
    <span style="color:#a6e22e">@Command</span>(<span style="color:#e6db74">&#39;mycommand&#39;</span>, category<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;misc&#39;</span>, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;does something&#39;</span>,
             parser<span style="color:#f92672">=</span>setup_argument_parser):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mycommand</span>(self, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#75715e"># arguments from MyModuleParser are in kwargs</span></code></pre></div>
<p>If the underlying <code>ArgumentParser</code> has arguments you&rsquo;d like to avoid exposing to your mach command,
you can use <a href="https://docs.python.org/2.7/library/argparse.html#default"><code>argparse.SUPPRESS</code></a> to hide it from the help.</p>

<h2 id="don-t-treat-the-underlying-library-like-a-black-box">Don&rsquo;t Treat the Underlying Library Like a Black Box</h2>

<p>Sometimes the underlying library is a huge mess. It can be very tempting to treat it like a black
box and use your mach command as a convenient little fantasy-land wrapper where you can put all the
nice things without having to worry about the darkness below.</p>

<p>This situation is temporary. You&rsquo;ll quickly make the situation way worse than before, as not only
will your mach command devolve into a similar state of darkness, but now changes to the underlying
library can potentially break your mach command. Just suck it up and pay a little technical debt
now, to avoid many times that debt in the future. Implement all new features and UX improvements
directly in the underlying library.</p>

<h2 id="keep-the-cli-simple">Keep the CLI Simple</h2>

<p>The command line is a user interface, so put some thought into making your command useable and
intuitive. It should be easy to figure out how to use your command simply by looking at its help. If
you find your command&rsquo;s list of arguments growing to a size of epic proportions, consider breaking
your command up into <a href="https://dxr.mozilla.org/mozilla-central/rev/904f3554c08488c53d24deb20a486600ddddd56b/python/mach/mach/decorators.py#241">subcommands</a> with an <code>@SubCommand</code> decorator.</p>

<p>Rather than putting the onus on your user to choose every minor detail, make the experience more
magical than a Disney band.</p>

<h2 id="be-annoyingly-helpful-when-something-goes-wrong">Be Annoyingly Helpful When Something Goes Wrong</h2>

<p>You want your mach command to be like one of those super helpful customer service reps. The ones
with the big fake smiles and reassuring voices. When something goes wrong, your command should calm
your users and tell them everything is ok, no matter what crazy environment they have.</p>

<p>Instead of printing an error message, print an error paragraph. Use natural language. Include all
relevant paths and details. Format it nicely. Create separate paragraphs for each possible failure.
But most importantly, only be annoying <em>after</em> something went wrong.</p>

<h2 id="use-conditions-liberally">Use Conditions Liberally</h2>

<p>A mach command will only be enabled if all of its <a href="http://gecko.readthedocs.org/en/latest/python/mach/commands.html#conditionally-filtering-commands">condition functions</a> return True. This keeps
the global |mach help| free of clutter, and makes it painfully obvious when your command is or isn&rsquo;t
supposed to work. A command that only works on Android, shouldn&rsquo;t show up for a Firefox desktop
developer. This only leads to confusion.</p>

<p>Here&rsquo;s an example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> mozbuild.base <span style="color:#f92672">import</span> (
    MachCommandBase,
    MachCommandConditions <span style="color:#66d9ef">as</span> conditions,
)

<span style="color:#a6e22e">@CommandProvider</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MachCommands</span>(MachCommandBase):
    <span style="color:#a6e22e">@Command</span>(<span style="color:#e6db74">&#39;mycommand&#39;</span>, category<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;post-build&#39;</span>, description<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;does stuff&#39;</span>
             conditions<span style="color:#f92672">=</span>conditions<span style="color:#f92672">.</span>is_android):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mycommand</span>(self):
        <span style="color:#66d9ef">pass</span></code></pre></div>
<p>If the user does not have an active fennec objdir, the above command will not show up by default in
|mach help|, and trying to run it will display an appropriate error message.</p>

<h2 id="design-breadth-first">Design Breadth First</h2>

<p>Put another way, keep the big picture in mind. It&rsquo;s ok to implement a mach command with super
specific functionality, but try to think about how it will be extended in the future and build with
that in mind. We don&rsquo;t want a situation where we clone a command to do something only slightly
differently (e.g |mach mochitest| and |mach mochitest-b2g-desktop| from back in the day) because the
original wasn&rsquo;t extensible enough.</p>

<p>It&rsquo;s good to improve a very specific use case that impacts a small number of people, but it&rsquo;s better
to create a base upon which other slightly different use cases can be improved as well.</p>

<h2 id="take-a-breath">Take a Breath</h2>

<p>Congratulations, now you are a mach guru. Take a breath, smell the flowers and revel in the
satisfaction of designing a great user experience. But most importantly, enjoy coming into work and
getting to use kick-ass tools.</p>

  

  
  <hr>
  <footer>

  
    <section>
    <h4>Share</h4>
    <nav class="nav sharing-icons">
      <a class="nav-item" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fahal.ca%2fblog%2f2016%2fzen-of-mach%2f" title="Share on Facebook"><span class="fa fa-facebook fa-2x" aria-hidden="true"></span></a>
      <a class="nav-item" href="https://plus.google.com/share?url=https%3a%2f%2fahal.ca%2fblog%2f2016%2fzen-of-mach%2f" title="Share on Google+"><span class="fa fa-google-plus fa-2x" aria-hidden="true"></span></a>
      <a class="nav-item" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fahal.ca%2fblog%2f2016%2fzen-of-mach%2f" title="Share on LinkedIn"><span class="fa fa-linkedin fa-2x" aria-hidden="true"></span></a>
      <a class="nav-item" href="https://twitter.com/home?status=https%3a%2f%2fahal.ca%2fblog%2f2016%2fzen-of-mach%2f" title="Tweet this"><span class="fa fa-twitter fa-2x"></span></a>
    </nav>
  </section>

  

  

  
    <section class="post-comments">
      










































      <br>
      <h4>Leave a comment</h4>
<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/ahal/hunting-the-shmoo/master/comments">
    <input type="hidden" name="options[redirect]" value="https://ahal.ca/blog/2016/zen-of-mach/#comment-submitted">
    <input type="hidden" name="options[slug]" value="zen-of-mach">
    <input class="post-comment-field" name="fields[name]" type="text" placeholder="Name (required)">
    <input class="post-comment-field" name="fields[email]" type="email" placeholder="E-mail (optional)">
    <textarea class="post-comment-field" name="fields[msg]" placeholder="Message (required, markdown enabled)" rows="10"></textarea>
    <input class="post-comment-field btn" type="submit" value="Submit">
</form>

<div id="comment-submitted">
  <p>Your comment has been submitted and will be published once it has been approved.</p>
</div>

    </section>
  
  </footer>
  

</article> 



        </div> <!-- /.blog-main -->

        <aside class="col-sm-3 ml-auto blog-sidebar">
  

  
        <section class="sidebar-module">
    <h4>Recent Posts</h4>
    <ol class="list-unstyled">


<li><a href="/casts/2019/task-configuration-at-scale/">Task Configuration at Scale</a></li>

<li><a href="/casts/2018/taskgraph-like-a-pro/">Taskgraph Like a Pro</a></li>

<li><a href="/blog/2018/website-refresh/">A New Look and Feel (and everything else)</a></li>

<li><a href="/blog/2017/mach-try-fuzzy/">Try Fuzzy: A Try Syntax Alternative</a></li>

<li><a href="/blog/2017/mercurial-absorb/">Absorbing Changes into a Commit Series with Mercurial</a></li>

<li><a href="/blog/2017/fuzzy-try-chooser/">A Course of Action for Replacing Try Syntax</a></li>

<li><a href="/blog/2016/taskcluster-interactive-loaner/">Using One Click Loaner to Debug Failures</a></li>

<li><a href="/blog/2016/zen-of-mach/">The Zen of Mach</a></li>

<li><a href="/blog/2015/try-syntax/">Looking beyond Try Syntax</a></li>

<li><a href="/blog/2015/making-mercurial-bookmarks-more-git-like/">Making mercurial bookmarks more git-like</a></li>

    </ol>
  </section>

  

  

  
  <section class="sidebar-module tag-cloud">
    <h4>Tag Cloud</h4>
    
    
        
            
            <a href="/tags/mozilla">mozilla</a>
        
    
        
            
            <a href="/tags/ateam">ateam</a>
        
    
        
            
            <a href="/tags/b2g">b2g</a>
        
    
        
            
            <a href="/tags/mercurial">mercurial</a>
        
    
        
            
            <a href="/tags/mach">mach</a>
        
    
        
            
            <a href="/tags/fzf">fzf</a>
        
    
        
            
            <a href="/tags/programming">programming</a>
        
    
        
            
            <a href="/tags/try">try</a>
        
    
        
            
            <a href="/tags/mozconfigwrapper">mozconfigwrapper</a>
        
    
        
            
            <a href="/tags/mozmill">mozmill</a>
        
    
        
            
            <a href="/tags/python">python</a>
        
    
        
            
            <a href="/tags/taskgraph">taskgraph</a>
        
    
        
            
            <a href="/tags/website">website</a>
        
    
        
            
            <a href="/tags/absorb">absorb</a>
        
    
        
            
            <a href="/tags/addon">addon</a>
        
    
        
            
            <a href="/tags/android">android</a>
        
    
        
            
            <a href="/tags/bookbinder">bookbinder</a>
        
    
        
            
            <a href="/tags/cycling">cycling</a>
        
    
        
            
            <a href="/tags/django">django</a>
        
    
        
            
            <a href="/tags/hugo">hugo</a>
        
    
        
            
            <a href="/tags/mozharness">mozharness</a>
        
    
        
            
            <a href="/tags/mozprofile">mozprofile</a>
        
    
        
            
            <a href="/tags/music">music</a>
        
    
        
            
            <a href="/tags/peptest">peptest</a>
        
    
        
            
            <a href="/tags/qqver">qqver</a>
        
    
        
            
            <a href="/tags/reddit">reddit</a>
        
    
        
            
            <a href="/tags/reftest">reftest</a>
        
    
        
            
            <a href="/tags/staticman">staticman</a>
        
    
        
            
            <a href="/tags/taskcluster">taskcluster</a>
        
    
        
            
            <a href="/tags/test-informant">test-informant</a>
        
    
        
            
            <a href="/tags/toronto">toronto</a>
        
    
  </section>
  
</aside>


      </div> <!-- /.row -->
    </div> <!-- /.container -->
    

    
    <footer class="blog-footer">
      <p>
      
      © 2018 Andrew Halberstadt
      
      </p>
      <p>
      <a href="#">Back to top</a>
      </p>
    </footer>
    

  </body>

</html>
